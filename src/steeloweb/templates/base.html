 {% load django_htmx %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}STEEL-IQ{% endblock %}</title>
    <!-- Bootstrap CSS (local vendor) -->
    <link href="{% static 'vendor/bootstrap-5.3.0/css/bootstrap.min.css' %}" rel="stylesheet">
    <!-- Font Awesome (local vendor) -->
    <link rel="stylesheet" href="{% static 'vendor/fontawesome-6.0.0/css/all.min.css' %}">
    <!-- Custom Fonts -->
    <link rel="stylesheet" href="{% static 'steeloweb/css/fonts.css' %}">
    <!-- Main Styles -->
    <link rel="stylesheet" href="{% static 'steeloweb/css/main.css' %}">
    <!-- HTMX -->
    {% htmx_script %}
    {% block extra_css %}{% endblock %}
</head>
<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{% url 'modelrun-list' %}">
                <img src="{% static 'steeloweb/images/Steel-IQ-signet-light.svg' %}" alt="" aria-hidden="true" style="height: 35px; margin-right: 10px;">
                <span>STEEL-IQ</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'modelrun-list' %}">Simulations</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'master-excel-list' %}">
                            <i class="fas fa-database me-1"></i>Master Excel
                        </a>
                    </li>
                </ul>
                <div class="ms-auto">
                    <img src="{% static 'steeloweb/images/systemiq-logo-white.png' %}" alt="Systemiq" style="height: 35px;">
                </div>
            </div>
        </div>
    </nav>

    {% block content %}{% endblock %}

    <!-- Memory Warning Modal -->
    <div class="modal fade" id="memoryWarningModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title">
              <i class="fas fa-exclamation-triangle"></i>
              Insufficient Memory Warning
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p><strong>Your system may not have sufficient memory for stable system operation.</strong></p>
            <p>Proceeding may cause:</p>
            <ul>
              <li>Simulation crashes due to memory errors</li>
              <li>Computer becoming very slow and unresponsive</li>
              <li>Other applications being impacted or crashing</li>
              <li>Loss of unsaved work</li>
            </ul>
            <p class="mb-0"><strong>Do you want to proceed anyway?</strong></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="button" class="btn btn-warning" id="confirmForceWorker">
              <i class="fas fa-exclamation-triangle"></i>
              Proceed Anyway
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast notification container -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="downloadToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header" id="downloadToastHeader">
                <i class="fas fa-download me-2" id="downloadToastIcon"></i>
                <strong class="me-auto">Download</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="downloadToastBody">
                <!-- Message inserted here -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies (local vendor) -->
    <script src="{% static 'vendor/bootstrap-5.3.0/js/bootstrap.bundle.min.js' %}"></script>

    <!-- Toast notification helper -->
    <script>
    function showDownloadToast(message, type = 'info') {
        const toastEl = document.getElementById('downloadToast');
        const toastHeader = document.getElementById('downloadToastHeader');
        const toastBody = document.getElementById('downloadToastBody');
        const toastIcon = document.getElementById('downloadToastIcon');

        // Map type to Bootstrap background classes and icons
        const typeConfig = {
            'info': { bg: 'bg-info text-white', icon: 'fa-info-circle' },
            'success': { bg: 'bg-success text-white', icon: 'fa-check-circle' },
            'warning': { bg: 'bg-warning text-dark', icon: 'fa-exclamation-triangle' },
            'danger': { bg: 'bg-danger text-white', icon: 'fa-exclamation-circle' }
        };

        const config = typeConfig[type] || typeConfig['info'];

        // Update header styling
        toastHeader.className = `toast-header ${config.bg}`;

        // Update icon
        toastIcon.className = `fas ${config.icon} me-2`;

        // Update message
        toastBody.textContent = message;

        // Show toast with auto-hide
        const toast = new bootstrap.Toast(toastEl, {
            animation: true,
            autohide: true,
            delay: 4000
        });
        toast.show();
    }
    </script>

    <!-- Worker management JavaScript -->
    <script>
    // Helper function to get CSRF token (standard Django pattern)
    function getCsrfToken() {
        // Try cookie first (standard Django CSRF middleware)
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];

        if (cookieValue) return cookieValue;

        // Fallback to meta tag if cookie not available
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        return metaTag ? metaTag.getAttribute('content') : '';
    }

    // Use document-level delegation so handler survives HTMX content swaps
    document.addEventListener('click', function(e) {
        // Check if click target is the Add Worker button
        const btn = e.target.closest('.add-worker-btn');
        if (!btn) return;

        const canAdd = btn.getAttribute('data-can-add') === 'True';

        // If can't add (either at capacity OR no capacity), show modal
        if (!canAdd) {
            // Prevent HTMX from triggering
            e.preventDefault();
            e.stopPropagation();

            // Get the HTMX post URL from the button
            const htmxPostUrl = btn.getAttribute('hx-post');

            // Show warning modal
            const modal = new bootstrap.Modal(document.getElementById('memoryWarningModal'));
            modal.show();

            // Setup confirmation handler (overwrite previous handler)
            document.getElementById('confirmForceWorker').onclick = function() {
                modal.hide();

                // Get CSRF token for manual HTMX request
                const csrfToken = getCsrfToken();

                // Trigger HTMX with force parameter and CSRF header
                htmx.ajax('POST', htmxPostUrl + '?force=true', {
                    target: '#worker-status-content',
                    swap: 'innerHTML',
                    indicator: '#manual-worker-loading',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
            };
        }
        // If canAdd is true, let HTMX handle normally (don't preventDefault)
    }, true); // Use capture phase to intercept before HTMX

    // Auto-check for workers on page load (for Electron startup)
    document.addEventListener('DOMContentLoaded', function() {
        // Skip if we've already done startup worker check this session
        if (sessionStorage.getItem('startup-worker-check-done')) {
            return;
        }

        // Only run on pages with worker UI OR on first-time-setup page
        const hasWorkerUI = document.getElementById('worker-status-content');
        const isFirstTimeSetup = window.location.pathname.includes('/first-time-setup/');

        if (!hasWorkerUI && !isFirstTimeSetup) return;

        // Check if we need to prompt for worker creation on startup
        fetch('/api/workers/status/')
            .then(r => r.json())
            .then(data => {
                const hasWorkers = data.workers.length > 0;
                const noCapacity = data.limits.no_capacity;

                // If no workers exist, show startup prompt
                if (!hasWorkers) {
                    // First check of the session - mark as done
                    sessionStorage.setItem('startup-worker-check-done', 'true');

                    if (noCapacity) {
                        // Show warning modal for low-memory startup
                        showStartupWorkerPrompt(true);
                    } else {
                        // Show simple prompt or auto-create worker
                        showStartupWorkerPrompt(false);
                    }
                } else {
                    // Workers already exist - mark check as done for this session
                    sessionStorage.setItem('startup-worker-check-done', 'true');
                }
            })
            .catch(err => {
                console.error('Failed to check worker status:', err);
            });
    });

    function showStartupWorkerPrompt(lowMemory) {
        // Get CSRF token from cookie or meta tag
        const csrfToken = getCsrfToken();

        if (lowMemory) {
            // Show memory warning modal (reuse memoryWarningModal)
            const modal = new bootstrap.Modal(document.getElementById('memoryWarningModal'));
            modal.show();

            document.getElementById('confirmForceWorker').onclick = function() {
                modal.hide();
                // Create worker with force flag
                fetch('/api/workers/add/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ force: true })
                }).then(() => {
                    // Refresh worker status if HTMX target exists
                    const target = document.getElementById('worker-status-content');
                    if (target) {
                        htmx.trigger(target, 'refresh');
                    }
                });
            };
        } else {
            // Auto-create worker without prompt (normal memory)
            fetch('/api/workers/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({})
            }).then(() => {
                // Refresh worker status if HTMX target exists
                const target = document.getElementById('worker-status-content');
                if (target) {
                    htmx.trigger(target, 'refresh');
                }
            });
        }
    }
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>